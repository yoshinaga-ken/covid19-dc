const IS_SP="ontouchstart"in window||window.innerWidth<=768,D2_PL1=0,D2_YMD=1,D2_P=2,D2_D=3,D2_REG=4,WT_CD=0,WT_NM=1,WT_P=2,WT_D=3,WT_PD=4,WT_DD=5,WT_AC=6,CND_LV_A="無症,退院",CND_LV_B="感染",CND_LV_C="肺炎,入院",CND_LV_D="酸投,重症",CND_LV_E="死亡",COND_COL=["#2ca02c","#1f77b4","#ff7f0e","#d62728","#9467bd"],COND_COL_A=COND_COL[0],COND_COL_B=COND_COL[1],COND_COL_C=COND_COL[2],COND_COL_D=COND_COL[3],COND_COL_E=COND_COL[4],IMG_NO="img/noimage.png",YMD_ED_F=[["2020-04-07","【緊急事態宣言】\n発令。７都府県\n対象：東京・埼玉・千葉・神奈川・大阪・兵庫・福岡"],["2020-04-16","【緊急事態宣言】\n対象を｢全国｣に拡大"],["2020-05-14","【緊急事態宣言】\n39県で解除\n継続：北海道・東京・埼玉・千葉・神奈川・大阪・京都・兵庫"],["2020-05-21","【緊急事態宣言】\n大阪・京都・兵庫を解除\n継続：北海道・東京・埼玉・千葉・神奈川"],["2020-05-25","【緊急事態宣言】\n全都道府県で解除"]],WORLD_REGIONS={0:["アフリカ","Africa"],2:["東地中海","Eastern Mediterranean"],3:["ヨーロッパ","Europe"],4:["東南アジア","South-East Asia"],5:["西太平洋","Western Pacific"],11:["北アメリカ","North Americas"],12:["中央アメリカ","Central Americas"],13:["南アメリカ","South Americas"]},CHART_YM_STACK1_N=2+_.size(WORLD_REGIONS),CHART_YM_STACK2_N=9,SPARK_SX=IS_SP?60:25,MAP_COL_TBL=[["1000人以上","#8c0a00"],["500人以上","#ea5432"],["100人以上","#ff781d"],["50人以上","#ff9d57"],["10人以上","#ffceab"],["1人以上","#f5deb3"],["0人","#dadada"],["選択中","#ffffff"]];colorbrewer.Set3[12][8]=colorbrewer.Set2[8][6],colorbrewer.Set2[8][7]=colorbrewer.Set1[8][6];const m_={config:{cDateYm:{is_elasticY:1},cJob:{TD:750,barWidth:45}},get:location_get_query(),url_data:"/data/covid19-world.json",url_name:"https://ja.wikipedia.org/wiki",composite:null,chartDate:null,chartLine:null,chartRegion:null,chartWorld:null,chartCondSel:null,lv_type:0,ndx2:{},world:[],world_tbl:{},gpWorld_all:{},ac_data:[],chartRegionColors:colorbrewer.Paired[9],chartWorldColors:d3.schemeTableau10,domainDate:[],dateCnt:{},datePick:null,dateCntMax:0,dateCntTo:"YYYYMMDD",sel_tab:"tabs_c",tip:null,tipRow:null,names:{},keyboard:null,keyboard_target:"name",keyboard_selector:"#name_flt",chartAllFilterByKW_render:0,is_drawJapanMap:1,is_drawWorldMap:1,is_filter_region_sel:0,line:d3.line().curve(d3.curveLinear),last_fth:"",dateCntCreate:function(){m_.dateCnt={},m_.dateCntMax=-1,m_.dateCntTo="00000000",_.forEach(m_.gpDate.all(),t=>{let e=moment(t.key).format("YYYYMMDD");m_.dateCnt[e]=t.value,t.value>m_.dateCntMax&&(m_.dateCntMax=t.value),t.value>0&&e>m_.dateCntTo&&(m_.dateCntTo=e)})},initSearchKeybord:function(){$.extend($.keyboard.keyaction,{cmd_search:function(t){var e=$(m_.keyboard_selector),r=$.Event("change");r.keyCode=$.ui.keyCode.ENTER,e.trigger(r)},cmd_clear:function(t){$(m_.keyboard_selector).val("").trigger("change")},cmd_close:function(t){return t.close(!0),$("#"+m_.keyboard_target+"_flt_div").hide(),!1}}),$(m_.keyboard_selector).on("change keyup",function(t){let e=$(this).val().trim(),r="#div_"+m_.keyboard_target,n=$(r+" g.row");for(var a=0;a<n.length;a++){let t=n.eq(a);-1!==t.find("text:eq(0)").text().split("(")[0].indexOf(e)?(t.show(),0):t.hide()}""!=e?m_.chartScroll(r,e,150):m_.chartScroll(r,"")}),m_.keyboard=$(m_.keyboard_selector).keyboard({layout:"custom",display:{cmd_search:'　<span class="ui-icon ui-icon-search"></span>検索　',cmd_clear:'　<span class="ui-icon ui-icon-closethick"></span>クリア　',cmd_close:'　　　　　　<span class="ui-icon ui-icon-circle-close"></span>閉じる　　　　　　',shift:"かな英数",accept:"　閉じる　"},customLayout:{normal:["ア カ ガ サ ザ タ ナ ハ バ マ ヤ ラ ワ {b}","イ キ ギ シ ジ チ ニ ヒ ビ ミ イ リ ン {b}","ウ ク グ ス ズ ツ ヌ フ ブ ム ユ ル & {b}","エ ケ ゲ セ ゼ テ ネ ヘ ベ メ エ レ | {b}","オ コ ゴ ソ ゾ ト ノ ホ ボ モ ヨ ロ ー {b}","{shift} {space} {cmd_clear}","{cmd_close}"],shift:["あ か が さ ざ た な は ば ま や ら わ {b}","い き ぎ し じ ち に ひ び み い り ん {b}","う く ぐ す ず つ ぬ ふ ぶ む ゆ る & {b}","え け げ せ ぜ て ね へ べ め え れ | {b}","お こ ご そ ぞ と の ほ ぼ も よ ろ ー {b}","{shift} {space} {cmd_clear} {cmd_search}","1 2 3 4 5 6 7 8 9 0 = {bksp}","~ ! @ # $ % ^ & * ( ) _ +","Q W E R T Y U I O P { } |",'A S D F G H J K L : " {cmd_search}',"{shift} Z X C V B N M < > ? {shift}","{cmd_close}"]},openOn:null,stayOpen:!0,noFocus:!0,usePreview:!1,change:function(t,e,r){$(m_.keyboard_selector).trigger("change")},position:IS_SP?{of:$(window),my:"left bottom",at:"left bottom-20",at2:"left bottom-20",collision:"fit fit"}:{of:$("#div_"+m_.keyboard_target),my:"left top",at:"left bottom+30",at2:"left bottom+20",collision:"fit fit"},visible:function(t,e){$(".ui-keyboard").css({cursor:"move",padding:"4px","padding-top":"32px"}).draggable()},beforeClose:function(t,e){}}),$(".flt_open_btn").button().on("click",function(){let t=$(this);m_.keyboardTargetChange(t.attr("keyboard_target"));let e=m_.keyboard.getkeyboard(),r="#"+m_.keyboard_target+"_flt_div";e.isOpen?(e.close(),$(r).hide()):(e.reveal(),$(r).show(),IS_SP||$("#"+m_.keyboard_target+"_flt").focus())})},keyboardTargetChange:function(t){m_.keyboard_target=t,m_.keyboard_selector="#"+t+"_flt"},getFilterTxt:function(){let t=$("#panel_region .filter_txt").text(),e=$("#panel_world .filter_txt").text(),r=$("#panel_date .filter_txt").text(),n=$("#chart_week .filter").text(),a=_.fill(Array(8),"");if(""!==t){let e="",r=t.split(",");for(i of r)e+=i.trim()+"と";a[1]=(1==r.length?"":"地域:【")+php_trim(e,"と")+(1==r.length?"":"】")}if(""!==e){let t="",r=e.split(",");for(i of r)t+=i.trim()+"と";a[2]=(1==r.length?"":"国名:【")+php_trim(t,"と")+(1==r.length?"":"】")}if(""!=r&&m_.chartDate.filters().length)if(m_.chartDate.brushOn())a.push(r);else{let t="",e=r.split(",");for(i of e)t+=i+"と";a[0]=(1==e.length?"":"【")+php_trim(t,"と")+(1==e.length?"":"】")}if(""!=n){let t=-1!==n.indexOf(",");a[3]="曜日:"+(t?"【":"")+n+(t?"】":"")}return a},chartWorldFilters:function(t,e,r){if(0===t.length)return m_.chartWorld.filterAll().render(),void(document.querySelector("#div_world").scrollTop=0);let n,a=[];_.forEach(m_.world_tbl,(r,l)=>{-1!==$.inArray(r[0],t)&&a.push(l),r[0]==e&&(n=l)}),m_.chartWorld.filterAll().filter([a]),m_.chartScroll("#div_world",r?n:_.last(a),150),dc.renderAll("chartGroup2")},chartWorldFilterReset:function(){m_.is_filter_region_sel=1,mapw.clearSelectedRegions(),m_.is_filter_region_sel=0,mapw.setFocus({x:.45,y:.48,scale:1,animate:!1}),document.querySelector("#div_world").scrollTop=0,m_.chartWorld.filterAll().render()},chartAllFilterByKW:function(t){if(!isNaN(t[0])){let e=moment(t);if(e.isValid()){let t=e.format("YYYY-MM-DD");if(-1!==t.indexOf("2001")){let r=t.split("-");e=moment("2020-"+r[1]+"-"+r[2])}return m_.composite.filterAll().filter(e.toDate()),m_.renderAllChart(),m_.barChartRedrawGroup(m_.chartDate),1}}let e=_.keys(m_.names),r="",n=0;const a=/\s+/;let l=[];for(pre1 of t.split(a))for(nm of e)pre1===nm&&(0===l.length&&(r=pre1.replace(nm,"")),l.push(nm),n=1);return n?(m_.chartWorld.filterAll().filter(1===l.length?l[0]:[l]),m_.renderAllChart(),m_.chartScroll("#div_world",l[0],300),1):0},parseURLParams:function(){let t;if(m_.get.name){let e=m_.get.name.split(" "),r=1===e.length?e[0]:[e];m_.chartWorld.filterAll().filter(r),$("#btn_search").val(e.join(" ")),t=0}if(m_.get.q&&($("#btn_search").val(m_.get.q.trim()),t=1),m_.get.date){const t=t=>{let e,r=t.split("-");switch(r.length){case 3:e=moment(r[0]+"-"+printf02d(r[1])+"-"+printf02d(t[2]));break;case 2:e=moment(moment().format("YYYY")+"-"+printf02d(r[0])+"-"+printf02d(r[1]));break;case 1:e=t}return e};let e,r,n=m_.get.date.split(" "),a=0;switch(n.length){case 1:e=t(n[0]),isNaN(parseInt(e))&&(a=dc.filters.RangedFilter(e.toDate(),e.add(1,"days").toDate()));break;case 2:e=t(n[0]),r=t(n[1]),a=isNaN(parseInt(r))?dc.filters.RangedFilter(e.toDate(),r.toDate()):dc.filters.RangedFilter(e.toDate(),e.add(r,"days").toDate())}a&&(m_.composite.brushOn(!0).render(),m_.composite.filter(a),$(".btn_brush").trigger("my_update",0))}t&&$("#btn_search").trigger("btn_search_update")},showFilterUi:function(t,e,r){let n=e.filters(),a=$(t);if(n.length){if($.isArray(n[0])){let t=r(n[0][0])+"～"+r(n[0][1]);a.find(".filter_txt").show().text(t).attr("title",t),a.find(".filter_txt_diff").text(moment(n[0][1]).diff(n[0][0],"days")+1+"日間")}else{let t=[];for(f of n)r&&(f=r(f)),t.push(f);let e=t.join(",");a.find(".filter_txt").show().text(e).attr("title",e),a.find(".filter_txt_diff").text("")}a.find(".reset_btn").show()}else a.find(".filter_txt").hide(),a.find(".reset_btn").hide()},on_chart_filtered:function(t,e){t.chartID();t.filters().length&&$("#ui-datepicker-div").is(":visible")&&m_.datePick.datepicker("show")},on_chart_postRedraw:function(t){t.transitionDuration(m_.config.cJob.TD),t.render()},render_v_line:function(t,e){t.g().select("g.chart-body").selectAll("path.line").data(e).enter().append("path").attr("class",function(t){return t.cls.concat(["line"]).join(" ")}).attr("d",function(e){let r=t.x()(e.x);return m_.line([[r,t.y().range()[0]],[r,t.y().range()[1]]])})},barChartRedrawGroup:function(t){let e=t.selectAll("rect.bar");if(0==e.size())return;let r=t.filters();0==r.length?e.classed("deselected",!1).classed("selected",!0):(e.classed("deselected",!0).classed("selected",!1),e.each(function(t,e,n){for(var a=0;a<r.length;a++)moment(t.x).isSame(r[a])&&$(this).removeClass("deselected").addClass("selected")}))},addFilterHandlerSingle:function(t,e){return window.event&&(window.event.ctrlKey||window.event.shiftKey)?(t.push(e),t):[e]},addFilterHandlerSingleR:function(t,e){return window.event&&(window.event.ctrlKey||window.event.shiftKey)?[e]:(t.push(e),t)},on_chartDate_pretransition:function(t){let e=$("#chart_date g.dc-legend-item"),r=m_.chartWorld.filters(),n=m_.chartRegion.filters(),a=r.length<2&&0===n.length,l=0===r.length&&n.length;if(a)e.filter(':contains("感染")').show(),e.filter(':contains("死亡")').show();else if(l)for(var i=0;i<n.length;i++)e.filter(':contains("'+WORLD_REGIONS[n[i]][0]+'")').show();else for(i=0;i<r.length;i++)e.filter(':contains("'+r[i]+'")').show();e.filter(':contains("週間")').show().attr("transform","translate(-100,0)"),m_.render_v_line(t,[{cls:["s1"],x:new Date(YMD_ED_F[0][0])},{cls:["s2"],x:new Date(YMD_ED_F[1][0])},{cls:["s2"],x:new Date(YMD_ED_F[2][0])},{cls:["s2"],x:new Date(YMD_ED_F[3][0])},{cls:["s3"],x:new Date(YMD_ED_F[4][0])}]),m_.is_drawWorldMap&&drawWorldMap(),m_.is_drawWorldMap=1;let o=m_.getFilterTxt();fth=o.join(" ").trim(),$(".hdr_flt").text((""===fth?"世界":fth)+"の状況"),"tabs_w"!==m_.sel_tab&&"tabs_c"!==m_.sel_tab||(fth=o.join(" ").trim(),$(".hdr_flt_map").text(""===fth?"":fth+"の状況")),t.selectAll("rect.bar").on("click",function(e){t.filter(e.data.key).redrawGroup(),m_.barChartRedrawGroup(t)}),$("#cnt_all").text(php_number_format(m_.ndx2.groupAll().reduceSum(t=>m_.lv_type?t[3]:t[2]).value()));let _=m_.lv_type?m_.gpDateD.all():m_.gpDate.all();if(_.length>=1){let t,e;for(i=_.length-1;i>=0&&0===_[i].value;i--);t=_[i],e=_[i-1],t&&($("#cnt_day").text(moment(t.key).format("YYYY/M/D(ddd)")+"時点"),h=t.value-e.value,$("#cnt_one").text((h>=0?"+":"")+php_number_format(h)))}else $("#cnt_one").text(""),$("#cnt_day").text("")},chartDateLegendUpdate:function(){let t=m_.chartWorld.filters(),e=m_.chartRegion.filters(),r=t.length<2&&0===e.length,n=0===t.length&&e.length;r||m_.composite.legend().y(n?-30:-170)},renderAllChart:function(){if(!m_.config.cDateYm.is_elasticY){let t=m_.lv_type?m_.gpDateD.all():m_.gpDate.all(),e=_.max(_.map(t,"value"));m_.chartDate.y(d3.scaleLinear().domain([0,e+10]))}dc.renderAll("chartGroup2"),IS_SP&&(d3.selectAll(".pie-slice").call(m_.tip),d3.selectAll(".pie-slice").on("mouseover",m_.tip.show).on("mouseout",m_.tip.hide),d3.selectAll(".bar").call(m_.tip),d3.selectAll(".bar").on("mouseover",m_.tip.show).on("mouseout",m_.tip.hide))},chartScroll:function(t,e,r){e=e||"",r=void 0===r?300:r;let n=$(t);if(""==e)return void n.scrollTop(0);let a=n.find('g.row:contains("'+e+'")');if(a.length){let t;if(IS_SP)t=a.attr("transform").replace(")","").split(",")[1]-40;else{let e=n.find("g.row:eq(0)").position();t=a.position().top-e.top-40}0===r?n.scrollTop(t):n.animate({scrollTop:t},r,"swing")}},remove_empty:function(t){return{all:function(){return t.all().filter(function(t){return 0!=t.value})}}},loadData:function(){const t="file:"===location.protocol;function e(t){m_.world=t.world,m_.world_tbl=t.world_tbl,m_.ac_data=t.ac_data,m_.init(),initDc()}m_.composite=new dc.CompositeChart("#chart_date","chartGroup2"),m_.chartDate=new dc.BarChart(m_.composite),m_.chartLine=new dc.LineChart(m_.composite),m_.chartRegion=new dc.RowChart("#chart_region","chartGroup2"),m_.chartWorld=new dc.RowChart("#chart_world","chartGroup2"),m_.chartCondSel=new dc.RowChart("#chart_condsel","chartGroup2"),t?e(g_covid19_world):d3.json(m_.url_data).then(e)},init:function(){IS_SP&&(m_.tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(){return $(this).find("title").text().replace(/\n/g,"<BR>")})),initAutoComplete(),$("#btn_search").autocomplete_ex({user_opt:{data:m_.ac_data,multiple:1,select:function(t,e){if("職業"===e.item[0]||"状態"===e.item[0])$("#btn_search").val(e.item[1]).trigger("btn_search_update");else{let t=$("#btn_search");const r=/\s+/;1===t.val().trim().split(r).length&&t.val(e.item[1]+" "),t.trigger("btn_search_update")}}}})}},initDc=t=>{m_.domainDate=[moment(m_.world[0][1]).add(3,"days").toDate(),moment(_.last(m_.world)[1]).add(3,"days").toDate()];const e=_.map(m_.world,0);_.uniq(e).length;m_.names=_.countBy(e);let r=crossfilter(m_.world);m_.ndx2=r;let n=r.dimension(function(t){return t[4]});m_.gpRegion=n.group().reduceSum(function(t){return t[2]}),m_.gpRegionD=n.group().reduceSum(function(t){return t[3]});let a=m_.lv_type?m_.gpRegionD:m_.gpRegion;m_.chartRegion.width(IS_SP?parseInt(window.innerWidth/2)-30:200).height(24+29*Object.keys(a.all()).length).fixedBarHeight(24).margins({top:0,left:10,right:10,bottom:20}).transitionDuration(750).dimension(n).group(a).addFilterHandler(m_.addFilterHandlerSingleR).ordinalColors(m_.chartRegionColors).filterPrinter(function(t){return t.map(function(t){return WORLD_REGIONS[t]}).join(", ")}).renderLabel(!0).label(function(t){return WORLD_REGIONS[t.key][0]}).renderTitleLabel(!0).title(function(t){return php_number_format(t.value)}).elasticX(!0).on("filtered",function(t,e){m_.showFilterUi("#panel_region",t,t=>WORLD_REGIONS[t][0]),m_.dateCntCreate(),m_.on_chart_filtered(t,e)}),m_.chartRegion.xAxis().ticks(0);let l=r.dimension(function(t){return t[0]}),i=l.group().reduce((t,e)=>(t[0]+=e[2],t[1]+=e[3],t),(t,e)=>(t[0]-=e[2],t[1]-=e[3],t),(t,e)=>[0,0]);i.all().forEach(t=>m_.gpWorld_all[t.key]=t.value[0]),i=function(t){return{all:function(){return t.all().filter(function(t){return 0!=t.value[0]})}}}(i);let o,c=320;if(IS_SP&&(c=window.innerWidth+60),m_.chartWorld.width(c).height(24+29*Object.keys(i.all()).length).fixedBarHeight(24).margins({top:0,left:10,right:10,bottom:20}).transitionDuration(750).dimension(l).group(i).addFilterHandler(m_.addFilterHandlerSingleR).ordering(function(t){return-t.value[m_.lv_type]}).valueAccessor(function(t){return t.value[m_.lv_type]}).titleLabelOffsetX(0).ordinalColors(m_.chartWorldColors).renderTitleLabel(!1).title(function(t){let e=m_.world_tbl[t.key];return ret=t.key+"\n感染者数: "+php_number_format(t.value[0])+"名"+(void 0===e||0===e[4]?"":" ▲"+php_number_format(e[4]))+"\n死亡者数: "+php_number_format(t.value[1])+"名"+(void 0===e||0===e[5]?"":" ▲"+php_number_format(e[5]))+"\n死亡率: "+_.round(t.value[1]/t.value[0],2)+"%\n",ret}).renderLabel(!0).label(function(t){let e=m_.world_tbl[t.key];let r=t.key;for(var n=0;n<7-t.key.length;n++)r+="　";let a=m_.gpWorld_all[t.key]!==t.value[0],l=m_.chartCondSel.filter(),i="",o="";if("感染"===l&&(i=php_sprintf("%' 9s",php_number_format(t.value[0]))+(void 0===e||0===e[4]||a?"         ":php_sprintf(" %' 7s","▲"+e[4]))+" "),"死亡"===l){let r=void 0===e||0===e[5]||a;o=php_sprintf("%' 7s",php_number_format(t.value[1]))+(r?"       ":php_sprintf(" %' 5s","▲"+e[5]))+(r?"":php_sprintf(" %' 5s","("+_.round(t.value[1]/t.value[0],2).toString().substr(1)+"%)"))}return r+i+o}).elasticX(!0).on("pretransition",function(t){t.selectAll("text.row").attr("x",32),t.selectAll("rect").attr("x",28),t.selectAll("g.row").append("svg:image").attr("width","26").attr("class","pl").attr("xlink:href",function(t,e){return m_.world_tbl[t.key]?"img/world/"+m_.world_tbl[t.key][1]+".png":IMG_NO}).on("click",function(t){next=m_.url_name+"/"+t.key,window.open(next)})}).on("filtered",function(t,e){m_.showFilterUi("#panel_world",t),$("#detail_div1,#detail_div2,#detail_div3,#detail_div4,#detail_div5").hide();let r=t.filters();if(0===r.length)return;m_.is_filter_region_sel=1,mapw.clearSelectedRegions();let n=[];_.forEach(m_.world_tbl,(t,e)=>{-1!==$.inArray(e,r)&&n.push(t[0])}),mapw.setSelectedRegions(n),m_.is_drawWorldMap=0,m_.is_filter_region_sel=0;for(var a=0;a<r.length;a++){let t=a+1,e=r[a],n=m_.world_tbl[e],l="<B>"+(n?'<img src="img/world/'+n[1]+'.png">':"")+'<a target="_blank" title="'+e+'の wikipediaへ" href="'+m_.url_name+"/"+e+'">'+e+"</a></B><BR>";n&&(l+="総人口　: <BR>地域　　: "+WORLD_REGIONS[n[6]][0]+"<BR>感染者数: "+php_number_format(n[2])+" ▲"+php_number_format(n[4])+"<BR>死亡者数: "+php_number_format(n[3])+" ▲"+php_number_format(n[5])+'<BR><a title="感染者数に対する死亡者率。死亡者数 ÷ 感染者数">死亡率</a>　: '+_.round(n[5]/n[4],2)+"%"),$("#detail_div"+t).html(l).hide().show()}$("#world-map").vectorMap("get","mapObject").setFocus({regions:n,animate:1}),"tabs_w"!==m_.sel_tab&&$('[href="#tabs_w"]').trigger("click"),$(".jvectormap-tip").hide(),m_.dateCntCreate()}),m_.chartWorld.xAxis().ticks(4),IS_SP)o=window.innerWidth+100,gap_val=-2;else{let t=window.innerWidth-($("#chart_map").width()+$("#panel_region").width()+$("#panel_world").width())-120;for($("#panel_date").width(t),o=t;;){if(o>1300){gap_val=-7;break}if(o>1250){gap_val=-6;break}if(o>1150){gap_val=-5;break}if(o>900){gap_val=-4;break}if(o>700){gap_val=-3;break}gap_val=-2;break}}let s=r.dimension(function(t){return d3.timeDay(new Date(t[1]))});m_.gpDate=s.group().reduceSum(function(t){return t[2]}),m_.gpDateD=s.group().reduceSum(function(t){return t[3]}),m_.dateCntCreate();let d=s.group().reduce((t,e)=>{t.lv_b+=e[2],t.lv_e+=e[3];let r=e[0],n=e[4];return void 0===t.ncnt[r]&&(t.ncnt[r]=[0,0]),t.ncnt[r][0]+=e[2],t.ncnt[r][1]+=e[3],void 0===t.rcnt[n]&&(t.rcnt[n]=[0,0]),t.rcnt[n][0]+=e[2],t.rcnt[n][1]+=e[3],t.total[0]+=e[2],t.total[1]+=e[3],t},(t,e)=>{t.lv_b-=e[2],t.lv_e-=e[3];let r=e[0],n=e[4];return void 0===t.ncnt[r]&&(t.ncnt[r]=[0,0]),t.ncnt[r][0]-=e[2],t.ncnt[r][1]-=e[3],void 0===t.rcnt[n]&&(t.rcnt[n]=[0,0]),t.rcnt[n][0]-=e[2],t.rcnt[n][1]-=e[3],t.total[0]-=e[2],t.total[1]-=e[3],t},(t,e)=>({ncnt:{},rcnt:{},ncntd:{},rcntd:{},lv_b:0,lv_e:0,total:[0,0]}));m_.chartDate.centerBar(!0).transitionDuration(750).dimension(s).elasticY(!0).group(d,"死亡",function(t){return m_.chartWorld.filters().length<2&&0===m_.chartRegion.filters().length&&m_.lv_type?t.value.lv_e:0}).stack(d,"感染",function(t){return m_.chartWorld.filters().length<2&&0===m_.chartRegion.filters().length?m_.lv_type?0:t.value.lv_b:0}).hidableStacks(!1).yAxisPadding("12%").renderLabel(!0).label(function(t,e){let r=moment(t.x).format("YYYYMMDD"),n=t.data.value.total[m_.lv_type];return n===m_.dateCntMax||r===m_.dateCntTo?0===n?"":php_number_format(n):""}).ordinalColors([COND_COL_E,COND_COL_B].concat(m_.chartRegionColors).concat(m_.chartWorldColors)).gap(gap_val).on("filtered",function(t,e){m_.on_chart_filtered(t,e)});{function m(t,e){return function(t,r){let n=m_.chartRegion.filters();return n.length&&0===m_.chartWorld.filters().length?(ret=-1!==$.inArray(e,n)&&t.value.rcnt[e]&&t.value.rcnt[e][m_.lv_type]||0,ret):0}}let t=_.sortBy(m_.chartRegion.group().all(),t=>-t.value);for(var f=0;f<t.length;f++){let e=t[f].key,r=WORLD_REGIONS[e][0];m_.chartDate.stack(d,r,m(m_.chartDate,e))}}{function u(t,e){return function(r,n){let a=m_.chartWorld.filters();return a.length>1&&0===m_.chartRegion.filters().length?(t.stack()[CHART_YM_STACK1_N+e-1].name=a[e-1],void 0===r.value.ncnt[a[e-1]]?0:r.value.ncnt[a[e-1]][m_.lv_type]):(t.stack()[CHART_YM_STACK1_N+e-1].name="(選択"+e+")",0)}}for(var p=1;p<9;p++)m_.chartDate.stack(d,"(選択"+p+")",u(m_.chartDate,p))}m_.chartLine.dimension(s).colors("red").group(m_.gpDate,"週間移動平均").valueAccessor(function(t,e){if(0===e){let t=m_.lv_type?m_.gpDateD.all():m_.gpDate.all();m_.work=_.values(_.mapValues(t,t=>t.value))}f=e-7+1;let r=m_.work.slice(f<0?0:f,f+7);return Math.round(_.sum(r)/7)}),m_.composite.width(o).height(IS_SP?200:250).margins({top:0,right:0,bottom:20,left:35}).legend(dc.legend().x(IS_SP?parseInt(o/3):200).y(0)).x(d3.scaleTime().domain(m_.domainDate)).mouseZoomable(!1).xUnits(d3.timeDay).renderHorizontalGridLines(!0).brushOn(!1).elasticY(m_.config.cDateYm.is_elasticY).title(function(t){let e=isNaN(t.value),r="";for(;;){let e=moment(t.key).format("YYYY-MM-DD");if(e===YMD_ED_F[0][0]){r=YMD_ED_F[0][1];break}if(e===YMD_ED_F[1][0]){r=YMD_ED_F[1][1];break}if(e===YMD_ED_F[2][0]){r=YMD_ED_F[2][1];break}if(e===YMD_ED_F[3][0]){r=YMD_ED_F[3][1];break}if(e===YMD_ED_F[4][0]){r=YMD_ED_F[4][1];break}break}let n="object"==typeof t.key?moment(t.key).format("YYYY/M/D(ddd)"):t.key;if(!e)return n+"\n週間移動平均: "+php_number_format(t.value)+"名";let a=m_.chartWorld.filters(),l=m_.chartRegion.filters(),i=a.length<2&&0===l.length,o=0===a.length&&l.length;if(i)return n+"\n────────\n"+(0===t.value.lv_b?"":"感染: "+php_number_format(t.value.lv_b)+"名\n")+(0===t.value.lv_e?"":"死亡: "+php_number_format(t.value.lv_e)+"名\n")+"────────\n計: "+php_number_format(t.value.lv_b+t.value.lv_e)+"名\n"+r;let c=o?t.value.rcnt:t.value.ncnt,s="",d=0,m=0;return _.forEach(c,(t,e)=>{let r=t[m_.lv_type];0!==r&&(fname=o?WORLD_REGIONS[e][0]:e,s+=t?fname+": "+php_number_format(r)+"名\n":"",d+=r,m++)}),n+"\n────────\n"+s+(m>1?"────────\n計: "+php_number_format(d)+"名":"")+"\n"+r}).on("pretransition",m_.on_chartDate_pretransition).addFilterHandler(m_.addFilterHandlerSingle).on("preRedraw",function(t){m_.chartDateLegendUpdate(),m_.chartDate.filterAll().filter([m_.composite.filters()])}).on("filtered",function(t,e){m_.showFilterUi("#panel_date",t,t=>moment(t).format("M/D(ddd)")),m_.on_chart_filtered(t,e)}).compose([m_.chartDate,m_.chartLine]),m_.composite.xAxis().ticks(7).tickFormat(function(t){return moment(t).format("M/Dddd")}),m_.composite.yAxis().ticks(5).tickFormat(d3.format("~s"));let h=_.sum(_.map(m_.gpDate.all(),"value")),g=_.sum(_.map(m_.gpDateD.all(),"value"));var b=crossfilter([["感染",h],["死亡",g]]).dimension(function(t){return t[0]}),v=b.group().reduceSum(function(t){return t[1]});m_.chartCondSel.width(IS_SP?parseInt(window.innerWidth/2)-30:200).height(24+29*Object.keys(v.all()).length).fixedBarHeight(24).margins({top:0,left:10,right:10,bottom:20}).transitionDuration(750).dimension(b).group(v).renderLabel(!0).titleLabelOffsetX(0).ordinalColors([COND_COL_B,COND_COL_E]).renderTitleLabel(!0).title(function(t){return php_number_format(t.value)}).elasticX(!0).addFilterHandler(function(t,e){return[e]}).on("filtered",function(t,e){let r=t.filters();for(;r.length;){let t=$("#panel_date .chart-title");if(-1!==$.inArray("感染",r)){m_.lv_type=0,t.html('<i class="fa fa-procedures"></i>感染者数');break}if(-1!==$.inArray("死亡",r)){m_.lv_type=1,t.html("死亡者数");break}break}if(m_.chartRegion.group(m_.lv_type?m_.gpRegionD:m_.gpRegion).render(),m_.chartWorld.render(),m_.config.cDateYm.is_elasticY){let t=m_.lv_type?m_.gpDateD.all():m_.gpDate.all(),e=_.max(_.map(t,"value"));m_.chartDate.y(d3.scaleLinear().domain([0,e+10])),m_.composite.render()}}),m_.chartCondSel.xAxis().ticks(0).tickFormat(d3.format("d")),m_.chartCondSel.filter(m_.is_lv_mode?"死亡":"感染"),IS_SP?$("#btn_search").attr({placeholder:"フィルタ",title:"国名や日付の入力でグラフのフィルタリングが行えます。"}).on("focus",function(t){t.preventDefault(),$(this).css("width","10em")}).on("blur",function(t){t.preventDefault(),$(this).css("width","6em")}):$("#btn_search").attr({placeholder:"国名や日付でフィルタ",title:"国名や日付の入力でグラフのフィルタリングが行えます。\nショートカットキー\n　フォーカス : Ctrl+Shift+F\n　全クリア : Ctrl+Shift+L"}),m_.parseURLParams(),m_.chartAllFilterByKW_render||m_.renderAllChart(),$("#btn_search").on("focus",function(t){_.delay(()=>$(this).select(),7)}),$("#div_date").scrollLeft(800),IS_SP||($("#btn_search").focus(),$(".ui-tooltip").hide()),$("#btn_download_csv").button().on("click",function(t){t.preventDefault();let e=_.sortBy(m_.ndx2.allFiltered(),t=>t[0]),r="地域,国名,日付,感染者数,死亡者数\n";for(var n=0;n<e.length;n++)r+=`${WORLD_REGIONS[e[n][4]][0]},${e[n][0]},${e[n][1]},${e[n][2]},${e[n][3]}\n`;let a=$(".hdr_flt").text().replace("の状況","");const l=new Uint8Array([239,187,191]),i="covid19 - ["+a+"].csv",o=new Blob([l,r],{type:"text/csv"});if(window.navigator.msSaveBlob)window.navigator.msSaveBlob(o,i);else{const t=(window.URL||window.webkitURL).createObjectURL(o),e=document.createElement("a");e.href=t,e.download=i,e.click(),(window.URL||window.webkitURL).revokeObjectURL(t)}})},initTabs=()=>{$("#chart_map_title").show(),m_.tab=$("#chart_map").tabs({active:0,activate:function(t,e){m_.sel_tab=e.newPanel.attr("id"),"tabs_w"!==m_.sel_tab&&(location.href="covid19.html?tab="+m_.sel_tab.replace("tabs_","")),IS_SP||$("#btn_search").focus().select()},create:function(t,e){$("#chart_map .ui-widget-header").append($('<span class="ui-icon ui-icon-circle-close sp_icon btn_close" ch_id="ch_pnl_map" style="float:right;top: 8px;"></span>'))}})},initAutoComplete=()=>{$.widget("ui.autocomplete_ex",$.ui.autocomplete,{options:{itemMax:16,minLength:1,delay:500,position:{my:"left top",at:"left bottom+12",collision:"none"},_usr:{AC_SPLIT_WD:/\s+/}},_create:function(){this._super(),this.widget().menu("option","items","> :not(.ac_ex-cate)")},_init:function(){var t=this;t.source=t.options.source=function(e,r){let n,a=this.option("itemMax");(n=t.options.user_opt.multiple?e.term.split(t.options._usr.AC_SPLIT_WD).pop():e.term).length&&(n=n.toLocaleLowerCase(),r(_.filter(t.options.user_opt.data,t=>{return(n[0].match(/[a-z]/i)?1:0)?-1!==t[2].toLocaleLowerCase().indexOf(n):-1!==WORLD_REGIONS[t[0]][0].indexOf(n)||-1!==t[1].indexOf(n)}).slice(0,a)))},t.options.focus=function(e,r){if(t.options.user_opt.multiple){let e=this.value.trim().split(t.options._usr.AC_SPLIT_WD);e.pop(),e.push(r.item[1]),e.push(""),this.value=e.join(" ")}else this.value=r.item[1];return!1},t.options.select=function(e,r){return e.preventDefault(),t.options.user_opt.select&&(ret=t.options.user_opt.select(e,r)),ret}},_renderMenu:function(t,e){let r=this,n="";$.each(e,function(e,a){let l;if(a[0]!=n){let e="";t.append("<li class='ac_ex-cate'>"+e+WORLD_REGIONS[a[0]][0]+"</li>"),n=a[0]}l=r._renderItemData(t,a)})},_renderItem:function(t,e){let r=this.element.val().trim();this.options.user_opt.multiple&&(r=_.last(r.split(this.options._usr.AC_SPLIT_WD)));let n=e[1],a='<span class="ac_ex-kwd">'+r.toUpperCase()+"</span>";n=n.replace(new RegExp(r,"gi"),a);let l=""!==e[2]?"img/world/"+e[2]+".png":"";return icon='<img width="30" src="'+l+'" onerror="this.src=\'/'+IMG_NO+"'\" />",n=icon+n,$("<li class='ac_ex-item'>").append($("<div>").html(n+"("+php_number_format(e[3])+")")).appendTo(t)}})};var mapw;const drawWorldMap=()=>{$("#world-map").empty();let t={};m_.chartWorld.group().all().forEach(function(e){let r=e.value[m_.lv_type];for(;;){if(r>999999){col=MAP_COL_TBL[0][1];break}if(r>499999){col=MAP_COL_TBL[1][1];break}if(r>99999){col=MAP_COL_TBL[2][1];break}if(r>49999){col=MAP_COL_TBL[3][1];break}if(r>9999){col=MAP_COL_TBL[4][1];break}if(r>0){col=MAP_COL_TBL[5][1];break}col=MAP_COL_TBL[6][1];break}void 0!==m_.world_tbl[e.key]&&(t[m_.world_tbl[e.key][0]]=col)}),(mapw=new jvm.Map({container:$("#world-map"),map:"world_mill",panOnDrag:!IS_SP,focusOn:{x:.5,y:.5,scale:1,animate:!1},backgroundColor:null,zoomOnScroll:!0,zoomOnScrollSpeed:1,zoomStep:1.4,regionsSelectable:!0,hoverOpacity:.7,regionStyle:{selected:{stroke:"#1a75ff","stroke-width":2}},series:{regions:[{attribute:"fill"},{scale:{"100万人以上":"#8c0a00","50万人以上":"#ea5432","10万人以上":"#ff781d","5万人以上":"#ff9d57","1万人以上":"#ffceab","1000人以上":"#f5deb3","選択中":"#ffffff"},attribute:"fill",legend:{vertical:!0}}]},onRegionTipShow:(t,e,r)=>{let n="";_.forEach(m_.world_tbl,(t,e)=>{t[0]===r&&(n=e)});let a=m_.world_tbl[n];if(""===n)return;if(!_.findLast(m_.world,t=>t[0]===n))return;let l=n+"<BR>感染者数: "+php_number_format(a[2])+"名"+(a&&0!==a[4]?" ▲"+php_number_format(a[4]):"")+"<BR>死亡者数: "+php_number_format(a[3])+"名"+(a&&0!==a[5]?" ▲"+php_number_format(a[5]):"")+"<BR>死亡率(死亡/感染): "+_.round(a[3]/a[2],2)+"%";e.html(l)},onRegionSelected:(t,e,r)=>{if(m_.is_filter_region_sel)return;$("#ch_pnl_world").prop("checked",!1).trigger("click");let n=mapw.getSelectedRegions();n.map(t=>mapw.mapData.paths[t].name);m_.chartWorldFilters(n,e,r),m_.is_drawWorldMap=0}})).series.regions[0].setValues(t),$(".jvectormap-legend-tick-sample:last").css({border:"3px solid #1a75ff"})};$(document).ready(function(){$("#chart_map_title").show(),m_.tab=$("#chart_map").tabs({active:0,activate:function(t,e){m_.sel_tab=e.newPanel.attr("id"),"tabs_w"!==m_.sel_tab&&(location.href="covid19.html?tab="+m_.sel_tab.replace("tabs_","")),IS_SP||$("#btn_search").focus().select()},create:function(t,e){$("#chart_map .ui-widget-header").append($('<span class="ui-icon ui-icon-circle-close sp_icon btn_close" ch_id="ch_pnl_map" style="float:right;top: 8px;"></span>'))}}),$(".btn_clear_all").on("click",function(t){t.preventDefault(),$("#btn_search").val(""),$(".filter_txt").text(""),$(".btn_brush").trigger("my_update",1),m_.is_drawWorldMap=1,$("#ui-datepicker-div").is(":visible")&&m_.datePick.datepicker("show"),dc.filterAll("chartGroup2"),m_.chartCondSel.filter(m_.lv_type?"死亡":"感染"),dc.renderAll("chartGroup2"),IS_SP||$("#btn_search").focus()}),$("#btn_search").on("keyup btn_search_update",function(t){if(t.preventDefault(),"btn_search_update"===t.type||t.keyCode===$.ui.keyCode.ENTER){let t=this.value.trim();""!==t&&(m_.chartAllFilterByKW_render=m_.chartAllFilterByKW(t),_.delay(()=>$(".ui-menu").hide(),200))}}),m_.datePick=$("#btn_date").val(moment().format("YYYY/MM/DD")).datepicker({showOn:"button",buttonText:'<i class="ui-icon ui-icon-calendar-day ui-icon-big"></i>',showOtherMonths:!0,numberOfMonths:IS_SP?[1,3]:[2,4],showCurrentAtPos:IS_SP?2:7,stepMonths:IS_SP?3:4,position:{of:$(window),my:"center",at:"center",collision:"fit fit"},onSelect:function(t,e){$("#btn_search").val(t).trigger("btn_search_update")},beforeShowDay:function(t){let e=[],r=t.getFullYear()+printf02d(t.getMonth()+1)+printf02d(t.getDate());e[0]=1,e[1]=$.datepicker.regional.ja&&void 0!==$.datepicker.regional.ja.holidays[r]?"holiday":"";let n=m_.dateCnt[r]||0;for(;;){if(n>999999){e[1]+=" c1000";break}if(n>499999){e[1]+=" c500";break}if(n>99999){e[1]+=" c100";break}if(n>49999){e[1]+=" c50";break}if(n>9999){e[1]+=" c10";break}if(n>0){e[1]+=" c1";break}break}return 0!==n&&(e[2]=php_number_format(m_.dateCnt[r])+"名"),e},beforeShow:function(t,e){m_.dateCntCreate();var r=e.dpDiv;setTimeout(function(){r.position(IS_SP?{my:"left top",at:"left bottom",collision:"fit none",of:$("#btn_search")}:{my:"left bottom",at:"right+280 bottom",collision:"fit fit",of:t})},IS_SP?100:5)}}),$(".ui-datepicker-trigger").addClass("ui-button ui-corner-all ui-widget"),$("#reset_btn_date").on("click",function(t){t.preventDefault(),m_.composite.filterAll(),m_.chartDate.filterAll(),m_.renderAllChart()}),$(".btn_close").button().on("click",function(t){t.preventDefault(),$("#"+$(this).attr("ch_id")).trigger("click")}),$(".btn_close2").button().on("click",function(t){t.preventDefault(),$(this).closest("tr").hide()}),$(".btn_brush").button().on("click",function(t){t.preventDefault();let e=m_.composite.brushOn();if(e)$("#reset_btn_date").trigger("click"),$("#panel_date .filter_txt_diff").text("");else{let t=m_.composite.filters();if(t.length){let e=[[[t[0],moment(_.last(t)).add(1,"days").toDate()]]];m_.composite.filter(e),m_.chartDate.filter(e)}}$(this).trigger("my_update",e)}).on("my_update",function(t,e){$(this).removeClass("btn_off btn_on").addClass(e?"btn_off":"btn_on"),m_.composite.brushOn(!e).render()}),IS_SP||$(".drag").draggable({snap:!0,snapTolerance:IS_SP?80:20,cursor:"move",handle:".chart-title"}),m_.keyboardTargetChange("world"),m_.initSearchKeybord()}),$(document).ready(function(){const t=[{ch:"#ch_pnl_world",div:"#panel_world"},{ch:"#ch_pnl_date",div:"#panel_date"},{ch:"#ch_pnl_map",div:"#chart_map"},{ch:"#ch_pnl_detail",div:"#panel_detail"}];function e(t){let e=$(t.ch),r=t.div;e.on("update",function(){let t=$(r);$(this).is(":checked")?t.show():t.hide()}).on("change",function(){$(this).trigger("update")}),e.is(":checked")||e.trigger("update")}for(var r=0;r<t.length;r++)e(t[r])}),$(document).keyup(function(t){switch(t.keyCode){case 76:t.ctrlKey&&t.shiftKey&&(document.activeElement&&"tbl_flt"===document.activeElement.id?$(id).val("").trigger("change"):$(".btn_clear_all").trigger("click"));break;case 70:if(t.ctrlKey&&t.shiftKey){let t=document.activeElement&&"tbl_flt"===document.activeElement.id?"#tbl_flt":"#btn_search";$(t).focus().select()}}}).tooltip({items:"[tt_title]",show:{effect:"show",delay:500},hide:0,content:function(){return $(this).attr("tt_title")}}),$(document).ready(function(){m_.loadData()});